name: ci

on:
  pull_request:
  push:
    branches:
      - main

# STYLE NOTES:
# - Do not change the working directory (using 'cd' or otherwise).

env:
  GOCACHE: ${{ github.workspace }}/.cache/go-build
  GOMODCACHE: ${{ github.workspace }}/.cache/go-mod

jobs:
  build-head:
    name: build-head (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: 1.25.x
          cache: false
      - uses: actions/cache@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-head-${{ matrix.os }}
      # make.bash cannot be invoked from other directories
      - name: build (unix)
        if: runner.os != 'Windows'
        working-directory: go/src
        run: ./make.bash
      # make.bash cannot be invoked from other directories
      - name: build (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: go\src
        run: .\make.bat
      # actions/upload-artifact drops executable bits; tar preserves mode bits in the archive.
      # See https://github.com/actions/upload-artifact/issues/38
      - name: package toolchain (tar)
        shell: bash
        run: tar -czf go-head-${{ matrix.os }}.tgz go/bin go/pkg
      - uses: actions/upload-artifact@v6
        with:
          name: go-head-${{ matrix.os }}
          path: |
            go-head-${{ matrix.os }}.tgz

  build-gotip:
    name: build-gotip (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: 1.25.x
          cache: false
      - uses: actions/checkout@v6
        with:
          repository: golang/go
          path: gotip
      - uses: actions/cache@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-gotip-${{ matrix.os }}
      # make.bash cannot be invoked from other directories
      - name: build (unix)
        if: runner.os != 'Windows'
        working-directory: gotip/src
        run: ./make.bash
      # make.bash cannot be invoked from other directories
      - name: build (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: gotip\src
        run: .\make.bat
      # actions/upload-artifact drops executable bits; tar preserves mode bits in the archive.
      # See https://github.com/actions/upload-artifact/issues/38
      - name: package toolchain (tar)
        shell: bash
        run: tar -czf go-gotip-${{ matrix.os }}.tgz gotip/bin gotip/pkg
      - uses: actions/upload-artifact@v6
        with:
          name: go-gotip-${{ matrix.os }}
          path: |
            go-gotip-${{ matrix.os }}.tgz

  test-std:
    name: test-std (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build-head
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-head-${{ matrix.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-head-${{ matrix.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-head-${{ matrix.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/go"
          export PATH="$GOROOT/bin:$PATH"
          go tool dist test -run='!^cmd'

  test-cmd:
    name: test-cmd (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build-head
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-head-${{ matrix.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-head-${{ matrix.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-head-${{ matrix.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/go"
          export PATH="$GOROOT/bin:$PATH"
          go tool dist test -run='^cmd'

  test-tools-stable:
    name: test-tools (stable, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: 1.25.x
          cache: false
      - name: test
        run: go test -C tools ./...

  test-tools-head:
    name: test-tools (head, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build-head
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-head-${{ matrix.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-head-${{ matrix.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-head-${{ matrix.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/go"
          export PATH="$GOROOT/bin:$PATH"
          go test -C tools ./...

  test-tools-gotip:
    name: test-tools (gotip, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build-gotip
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-gotip-${{ matrix.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-gotip-${{ matrix.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-gotip-${{ matrix.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/gotip"
          export PATH="$GOROOT/bin:$PATH"
          go test -C tools ./...

  test-delve-stable:
    name: test-delve (stable, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: 1.25.x
          cache: false
      - name: test
        run: go test -C delve ./...

  test-delve-head:
    name: test-delve (head, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build-head
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-head-${{ matrix.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-head-${{ matrix.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-head-${{ matrix.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/go"
          export PATH="$GOROOT/bin:$PATH"
          go test -C delve ./...

  test-delve-gotip:
    name: test-delve (gotip, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build-gotip
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-gotip-${{ matrix.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-gotip-${{ matrix.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-gotip-${{ matrix.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/gotip"
          export PATH="$GOROOT/bin:$PATH"
          go test -C delve ./...
