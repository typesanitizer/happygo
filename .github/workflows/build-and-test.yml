name: build-and-test

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string

# STYLE NOTES:
# - Do not change the working directory (using 'cd' or otherwise).

env:
  GOCACHE: ${{ github.workspace }}/.cache/go-build
  GOMODCACHE: ${{ github.workspace }}/.cache/go-mod

jobs:
  build-head:
    name: build-head (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: 1.25.x
          cache: false
      - uses: actions/cache@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-cache-head-${{ inputs.os }}
      # make.bash cannot be invoked from other directories
      - name: build (unix)
        if: runner.os != 'Windows'
        working-directory: go/src
        run: ./make.bash
      # make.bash cannot be invoked from other directories
      - name: build (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: go\src
        run: .\make.bat
      # actions/upload-artifact drops executable bits; tar preserves mode bits in the archive.
      # See https://github.com/actions/upload-artifact/issues/38
      - name: package toolchain (tar)
        shell: bash
        run: |
          # The command below only considers .go files which are gitignored.
          # These must be files generated by make.bash. Other files don't need
          # to be packaged up because downstream jobs for tools/ or delve/ will
          # checkout the whole repo, so they'll have a copy of go/src etc. anyway.
          # Reducing the tarball size saves time on transfer, compression,
          # and GitHub Actions space utilization.
          git ls-files --ignored --exclude-standard -o -- ':(glob)go/**/*.go' | \
            xargs tar -czf go-head-${{ inputs.os }}.tgz go/bin go/pkg
      - uses: actions/upload-artifact@v6
        with:
          name: go-head-${{ inputs.os }}
          path: |
            go-head-${{ inputs.os }}.tgz

  build-gotip:
    name: build-gotip (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: 1.25.x
          cache: false
      - uses: actions/checkout@v6
        with:
          repository: golang/go
          path: gotip
      - uses: actions/cache@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-cache-gotip-${{ inputs.os }}
      # make.bash cannot be invoked from other directories
      - name: build (unix)
        if: runner.os != 'Windows'
        working-directory: gotip/src
        run: ./make.bash
      # make.bash cannot be invoked from other directories
      - name: build (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: gotip\src
        run: .\make.bat
      # actions/upload-artifact drops executable bits; tar preserves mode bits in the archive.
      # See https://github.com/actions/upload-artifact/issues/38
      - name: package toolchain (tar)
        shell: bash
        run: |
          # See https://github.com/golang/go/issues/61928#issuecomment-1673658972 ;
          # GOPROXY is read from go.env, so package that up.
          # gotip/src is included for access to stdlib APIs when compiling code
          # examples in Delve tests using gotip.
          tar -czf go-gotip-${{ inputs.os }}.tgz gotip/bin gotip/pkg gotip/src gotip/go.env
      - uses: actions/upload-artifact@v6
        with:
          name: go-gotip-${{ inputs.os }}
          path: |
            go-gotip-${{ inputs.os }}.tgz

  test-std:
    name: test-std (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    needs: build-head
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-head-${{ inputs.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-head-${{ inputs.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-cache-head-${{ inputs.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/go"
          export PATH="$GOROOT/bin:$PATH"
          go tool dist test -run='!^cmd'

  test-cmd:
    name: test-cmd (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    needs: build-head
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-head-${{ inputs.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-head-${{ inputs.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-cache-head-${{ inputs.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/go"
          export PATH="$GOROOT/bin:$PATH"
          go tool dist test -run='^cmd'

  test-tools:
    name: test-tools (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    needs: build-head
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: go-head-${{ inputs.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-head-${{ inputs.os }}.tgz -p
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-cache-head-${{ inputs.os }}
      - name: test
        shell: bash
        run: |
          export GOROOT="$PWD/go"
          export PATH="$GOROOT/bin:$PATH"
          go test -C tools ./...

  test-delve:
    name: test-delve (${{ inputs.os }}, ${{ matrix.go-toolchain }})
    runs-on: ${{ inputs.os }}
    needs: [build-head, build-gotip]
    continue-on-error: ${{ matrix.go-toolchain == 'gotip' }}
    strategy:
      matrix:
        go-toolchain: [head, stable, gotip]
    steps:
      - uses: actions/checkout@v6
      # Stable Go is used only for fixture builds; capture its GOROOT before PATH changes.
      - uses: actions/setup-go@v5
        if: matrix.go-toolchain == 'stable'
        with:
          go-version: 1.25.x
          cache: false
      - name: capture stable GOROOT
        id: stable-goroot
        if: matrix.go-toolchain == 'stable'
        shell: bash
        run: echo "path=$(go env GOROOT)" >> $GITHUB_OUTPUT
      - uses: actions/download-artifact@v7
        with:
          name: go-head-${{ inputs.os }}
          path: .
      - name: unpack toolchain (tar)
        shell: bash
        run: tar -xzf go-head-${{ inputs.os }}.tgz -p
      - uses: actions/download-artifact@v7
        if: matrix.go-toolchain == 'gotip'
        with:
          name: go-gotip-${{ inputs.os }}
          path: .
      - name: unpack toolchain (tar)
        if: matrix.go-toolchain == 'gotip'
        shell: bash
        run: tar -xzf go-gotip-${{ inputs.os }}.tgz -p
      # Procdump is required for TestMinidump on Windows.
      - name: install procdump (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Procdump.zip" -OutFile "$env:TEMP\procdump.zip"
          Expand-Archive -Force -LiteralPath "$env:TEMP\procdump.zip" -DestinationPath "$env:RUNNER_TOOL_CACHE\procdump"
          echo "$env:RUNNER_TOOL_CACHE\procdump" >> $env:GITHUB_PATH
      - uses: actions/cache/restore@v5
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          key: go-cache-head-${{ inputs.os }}
      - name: test
        shell: bash
        env:
          STABLE_GO_ROOT: ${{ steps.stable-goroot.outputs.path }}
        run: |
          export GOROOT="$PWD/go"
          export PATH="$GOROOT/bin:$PATH"
          # Use a custom go tool when building fixtures for stable/gotip.
          case "${{ matrix.go-toolchain }}" in
            stable) export DELVE_TEST_GO="$STABLE_GO_ROOT/bin/go" ;;
            gotip)  export DELVE_TEST_GO="$PWD/gotip/bin/go" ;;
            head)   ;;
          esac
          go test -C delve ./...
